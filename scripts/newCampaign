
#!/bin/bash

export JWT=`./signIn`

curl \
	-H "Content-Type: application/json" \
	-H "Authorization: Bearer $JWT" \
	--request POST \
	--data '{"name":"Patient enrolment campaign","description":"Patient enrolment campaign","goal":"This will enable self-enrolment of patients","typeInfo":{"campaignType":"PATIENT_ENROLMENT","comments":"Patient Enrolment"},"delivery":{"web":{"nav":[{"type":"title","id":"dfbbd6b6-309a-4d98-9094-b3588f354821","requestType":"PUT","title":"Welcome to ${auth.rpm.clinic.name}","buttonText":"Next","hint":"Press ENTER","logoUrl":"${auth.rpm.clinic.logoUrl}"},{"type":"media","id":"48699026-a771-4506-be04-e050ea8fe982","requestType":"PUT","title":"Here is a video","url":"https://www.youtube.com/watch?v=2GdN9fmPlzk","buttonText":"Next","hint":"Press ENTER","mediaType":"VIDEO"},{"type":"choice","id":"ee33bebf-9c3b-407b-afd6-c060419e5248","requestType":"POST","processing":{"processor":{"type":"processor","script":{"contents":"/* Have phone processor */\nfunction execute(input) {\n    print(\"Have phone processor\");\n\n    var retVal = null;\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var formData = scriptInput.formData;\n    var nav = scriptInput.nav;\n\n    var branchNav = nav.successNav;\n\n    var ifCondition = branchNav.ifCondition;\n\n    var conditionMatched = eval(ifCondition.condition);\n\n    if (conditionMatched) {\n        retVal = ifCondition.nav;\n    } else {\n        var elseIfCondition = branchNav.elseIfCondition;\n\n        if (elseIfCondition != null) {\n            for (var c in elseIfCondition) {\n                conditionMatched = eval(c.condition);\n\n                if (conditionMatched) {\n                    retVal = c.nav;\n                    break;\n                }\n            }\n        }\n    }\n\n    if (!conditionMatched && branchNav.elseCondition != null) {\n        conditionMatched = eval(branchNav.elseCondition.condition);\n\n        if (conditionMatched) {\n            retVal = branchNav.elseCondition.nav;\n        }\n    }\n\n    if (retVal == null) {\n        retVal = branchNav.failureNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"branch","id":"878e6b4e-157f-4e6e-9fcd-5959a8ba6006","requestType":"PUT","ifCondition":{"type":"if","condition":"formData.yes == \"Yes\"","nav":{"type":"form","id":"c6c66d7e-dbf6-4216-b894-05e167ed14f3","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"/* Register pre-processor */\n\nfunction execute(input) {\n    print(\"Register pre-processor\");\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"/* Register processor */\nfunction execute(input) {\n    print(\"Register processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort(true);\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"/* Register post-processor */\nfunction execute(input) {\n    print(\"Register post-processor\");\n\n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"form","id":"2ba6d26c-7a5f-49dd-8316-1979db222a80","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"/* Terms pre-processor */\nfunction execute(input) {\n    print(\"Terms pre-processor\");\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"/* Terms processor */\nfunction execute(input) {\n    print(\"Terms processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort(true);\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"/* Terms post processor */\nfunction execute(input) {\n    print(\"Terms post processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var authToken = context.authToken;\n\n    var helper = input[\"campaign.helper\"];\n\n    var mh = input[\"campaign.handler.db\"].member;\n    var wdh = input[\"campaign.handler.db\"].workflowData;\n    var twh = input[\"campaign.handler.twilio\"].twilio;\n    var rpmh = input[\"campaign.handler.http.rpm\"].rpm;\n    var ph = input[\"campaign.handler.pdf\"].pdf;\n\n    var clinicId = authToken.rpm.clinic.id;\n\n    var userFormData = wdh.get(clinicId, context.campaignId, context.containerId, 1);\n    var signatureFormData = wdh.get(clinicId, context.campaignId, context.containerId, 2);\n\n    var consentForm = helper.download(\"ConsentFormAnnotated.pdf\");\n\n    var data = helper.newMap();\n\n    data.put(\"patientFullName\", userFormData.firstName + \" \" + userFormData.lastName);\n    data.put(\"todaysDate\", helper.today());\n    data.put(\"patientSignature\", helper.download(context.campaignId, signatureFormData.file));\n    data.put(\"clinicName\", authToken.rpm.clinic.name);\n\n    var consentFormUrl = ph.transform(consentForm, context.campaignId, data);\n\n    var memberInput = helper.newMember();\n\n    var phoneNumber = userFormData.phoneNumber;\n\n    var phoneType = twh.getPhoneType(\"1\" + phoneNumber);\n\n    memberInput.clinicId = clinicId;\n    memberInput.firstName = userFormData.firstName;\n    memberInput.lastName = userFormData.lastName;\n    memberInput.phoneNumber = phoneNumber;\n    memberInput.phoneType = phoneType;\n    memberInput.roleName = \"PATIENT\";\n    memberInput.consentFormUrl = consentFormUrl;\n\n    var memberId = mh.add(memberInput);\n\n    var existingPatient = rpmh.userIfExists(phoneNumber);\n\n    if (existingPatient != null) {\n        /* Just add consent doc URL */\n        rpmh.updateConsentFormUrl(existingPatient.id, consentFormUrl);\n    } else {\n        /* Create patient in RPM */\n        var userInput = {\n\t  templateType: \"CHF\",\n\t  firstName: userFormData.firstName,\n\t  lastName: userFormData.lastName,\n\t  mobileNumber: phoneNumber,\n\t  consentFormUrl: consentFormUrl,\n\t  userType: \"PATIENT\",\n\t  role: \"patient\",\n\t  userName: phoneNumber,\n\t  clinicId: clinicId,\n\t  billingApproverId: authToken.approverId,\n\t  billingApproverName: authToken.approverName,\n\t  initialPassword: \"123456\",\n          phoneNumber: \"\",\n          address:{},\n          diagnosis:{}\n\t};\n\n        var userOutput = rpmh.create(userInput);\n\n        print(\"User output: \" + userOutput);\n    }\n \n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"title","id":"357d3dff-5f50-44ac-ab25-4e9ae1f638c1","requestType":"PUT","title":"Thank you. You should receive an SMS","buttonText":"Finish","hint":"Press ENTER"},"failureNav":{"type":"title","id":"f8eb44c7-fa9f-4f0f-b99f-cec7a101be5f","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"url","title":"Consent Form","url":"http://192.168.0.110:6060/api/file/ConsentForm.pdf"},{"type":"file-input","fieldName":"signature","hint":"Signature"}],"title":"Terms","buttonText":"Submit","hint":"Press ENTER"},"failureNav":{"type":"title","id":"e1096f8c-c668-4e4d-941c-da5b997e3e8f","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"text-input","fieldName":"firstName","fieldType":"NAME","title":"First Name","hint":"Enter first name"},{"type":"text-input","fieldName":"lastName","fieldType":"NAME","title":"Last Name","hint":"Enter last name"},{"type":"text-input","fieldName":"phoneNumber","fieldType":"PHONE_NUMBER","title":"Phone Number","hint":"Enter phone number"}],"title":"Enter details","buttonText":"Submit","hint":"Press ENTER"}},"elseCondition":{"type":"else","nav":{"type":"title","id":"7334cb3a-cc3f-47ef-bec2-5dce43fe9f38","requestType":"PUT","title":"Sorry, you need a smartphone","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"299f305d-9f0f-4517-a510-24d9f046421e","requestType":"PUT","title":"Sorry, you need a smartphone","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"4532f168-4fb4-4480-92aa-0c93e49b2440","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"choices":[{"type":"choice-input","fieldName":"yes","title":"Yes","fieldValue":"Yes"},{"type":"choice-input","fieldName":"no","title":"No","fieldValue":"No"}],"choiceType":"SINGLE","title":"Do you have a smartphone?","buttonText":"Next","hint":"Press ENTER"}]}}}' \
	http://192.168.0.110:6060/api/campaign

