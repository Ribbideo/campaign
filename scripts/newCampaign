
#!/bin/bash

export JWT=`./signIn`

curl \
	-H "Content-Type: application/json" \
	-H "Authorization: Bearer $JWT" \
	--request POST \
	--data '{"name":"Patient enrolment campaign","description":"Patient enrolment campaign","goal":"This will enable self-enrolment of patients","typeInfo":{"campaignType":"PATIENT_ENROLMENT","comments":"Patient Enrolment"},"delivery":{"web":{"nav":[{"type":"title","id":"b1968b90-12f9-4dd9-b6e6-217fdee41dfa","requestType":"PUT","title":"Welcome to the campaign","buttonText":"Next","hint":"Press ENTER"},{"type":"media","id":"747fe5d2-45d0-453a-b485-ac9afa9b78bf","requestType":"PUT","title":"Here is a video","url":"https://www.youtube.com/watch?v=LEUwgnBkFyU","buttonText":"Next","hint":"Press ENTER","mediaType":"VIDEO"},{"type":"choice","id":"3aa756e2-58c2-4cb0-a22d-d28b70a0c03a","requestType":"POST","processing":{"processor":{"type":"processor","script":{"contents":"// Check if user has smartphone\nfunction execute(input) {\n    var retVal = null;\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var formData = scriptInput.formData;\n    var nav = scriptInput.nav;\n\nprint(\"Input \" + nav);\n\n    var branchNav = nav.successNav;\n\nprint(\"Branch \" + branchNav);\n\n    var ifCondition = branchNav.ifCondition;\n\n    var conditionMatched = eval(ifCondition.condition);\n\n    if (conditionMatched) {\n        retVal = ifCondition.nav;\n    } else {\n        var elseIfCondition = branchNav.elseIfCondition;\n\n        if (elseIfCondition != null) {\n            for (var c in elseIfCondition) {\n                conditionMatched = eval(c.condition);\n\n                if (conditionMatched) {\n                    retVal = c.nav;\n                    break;\n                }\n            }\n        }\n    }\n\n    if (!conditionMatched && branchNav.elseCondition != null) {\n        conditionMatched = eval(branchNav.elseCondition.condition);\n\n        if (conditionMatched) {\n            retVal = branchNav.elseCondition.nav;\n        }\n    }\n\n    if (retVal == null) {\n        retVal = branchNav.failureNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"branch","id":"c4180df9-da44-4d0d-93f3-f30a0c714bcd","requestType":"PUT","ifCondition":{"type":"if","condition":"formData.yes == \"Yes\"","nav":{"type":"form","id":"27b24b76-5d3f-4809-81e6-1ac3aff8eb17","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"// Enrolment form pre-processing script\nfunction execute(input) {\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"// Enrolment form processing script\nfunction execute(input) {\n    print(\"Form processing\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort = true;\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"// Enrolment form post-processing script\nfunction execute(input) {\n    print(\"Form processing\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberInput = scriptInput.newMember();\n\n    memberInput.providerId = context.providerId;\n    memberInput.firstName = formData.firstName,\n    memberInput.lastName = formData.lastName,\n    memberInput.mobileNumber = formData.mobileNumber,\n    memberInput.roleName = \"PATIENT\";\n\n    var memberId = memberHandler.add(memberInput);\n\n    print(\"Member Id: \" + memberId);\n\n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"form","id":"4657f074-19f0-4983-a872-8ffdd8364aac","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"// Enrolment form pre-processing script\nfunction execute(input) {\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"// Enrolment form processing script\nfunction execute(input) {\n    print(\"Form processing\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort = true;\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"// Enrolment form post-processing script\nfunction execute(input) {\n    print(\"Form processing\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberInput = scriptInput.newMember();\n\n    memberInput.providerId = context.providerId;\n    memberInput.firstName = formData.firstName,\n    memberInput.lastName = formData.lastName,\n    memberInput.mobileNumber = formData.mobileNumber,\n    memberInput.roleName = \"PATIENT\";\n\n    var memberId = memberHandler.add(memberInput);\n\n    print(\"Member Id: \" + memberId);\n\n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"title","id":"7c02ec12-8a5e-4ab0-8997-61ef6a9ee004","requestType":"PUT","title":"Thank you. You should receive an SMS","buttonText":"Finish","hint":"Press ENTER"},"failureNav":{"type":"title","id":"6828e96c-aeaf-481e-968c-4159e70860c3","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"url","title":"Terms","url":"http://google.com"},{"type":"file-input","fieldName":"signature","hint":"Signature"}],"title":"Terms","buttonText":"Submit","hint":"Press ENTER"},"failureNav":{"type":"title","id":"e05fe355-dd78-497d-a71d-143ca96be1e6","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"text-input","fieldName":"firstName","title":"First Name","hint":"Enter first name"},{"type":"text-input","fieldName":"lastName","title":"Last Name","hint":"Enter last name"},{"type":"text-input","fieldName":"mobileNumber","title":"Mobile Number","hint":"Enter mobile number"}],"title":"Enter details","buttonText":"Submit","hint":"Press ENTER"}},"elseCondition":{"type":"else","nav":{"type":"title","id":"c6f9f6e8-8fc1-4528-8365-4c2252f25487","requestType":"PUT","title":"Sorry, you need a smartphone","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"3ec2caa2-2069-47ae-8ca1-86febc1e5d5f","requestType":"PUT","title":"Oops. No condition matched. Check your script","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"1d72b7cc-94a4-4420-9639-a9e2a67ef2a4","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"choices":[{"type":"choice-input","fieldName":"yes","title":"Yes","fieldValue":"Yes"},{"type":"choice-input","fieldName":"no","title":"No","fieldValue":"No"}],"choiceType":"SINGLE","title":"Do you have a smartphone?","buttonText":"Next","hint":"Press ENTER"}]}}}' \
	http://localhost:6060/api/campaign

