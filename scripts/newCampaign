
#!/bin/bash

export JWT=`./signIn`

curl \
	-H "Content-Type: application/json" \
	-H "Authorization: Bearer $JWT" \
	--request POST \
	--data '{"name":"Patient enrolment campaign","description":"Patient enrolment campaign","goal":"This will enable self-enrolment of patients","typeInfo":{"campaignType":"PATIENT_ENROLMENT","comments":"Patient Enrolment"},"delivery":{"web":{"nav":[{"type":"title","id":"dbd74970-836e-46d2-8ef7-b4b5f97a5ffa","requestType":"PUT","title":"Welcome to the campaign","buttonText":"Next","hint":"Press ENTER"},{"type":"media","id":"ca70cc07-ef3c-415e-a1de-00a5a728ccc7","requestType":"PUT","title":"Here is a video","url":"https://www.youtube.com/watch?v=LEUwgnBkFyU","buttonText":"Next","hint":"Press ENTER","mediaType":"VIDEO"},{"type":"choice","id":"520eb472-279f-42a3-bd67-b93fdeffe8bb","requestType":"POST","processing":{"processor":{"type":"processor","script":{"contents":"// Have phone processor\nfunction execute(input) {\n    print(\"Have phone processor\");\n\n    var retVal = null;\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var formData = scriptInput.formData;\n    var nav = scriptInput.nav;\n\n    var branchNav = nav.successNav;\n\n    var ifCondition = branchNav.ifCondition;\n\n    var conditionMatched = eval(ifCondition.condition);\n\n    if (conditionMatched) {\n        retVal = ifCondition.nav;\n    } else {\n        var elseIfCondition = branchNav.elseIfCondition;\n\n        if (elseIfCondition != null) {\n            for (var c in elseIfCondition) {\n                conditionMatched = eval(c.condition);\n\n                if (conditionMatched) {\n                    retVal = c.nav;\n                    break;\n                }\n            }\n        }\n    }\n\n    if (!conditionMatched && branchNav.elseCondition != null) {\n        conditionMatched = eval(branchNav.elseCondition.condition);\n\n        if (conditionMatched) {\n            retVal = branchNav.elseCondition.nav;\n        }\n    }\n\n    if (retVal == null) {\n        retVal = branchNav.failureNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"branch","id":"bf0f6ace-c5be-49ca-8a75-1ca8d9688df7","requestType":"PUT","ifCondition":{"type":"if","condition":"formData.yes == \"Yes\"","nav":{"type":"form","id":"6e731b14-ca2e-4af5-9c99-2ed8e46953f9","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"// Register pre-processor\nfunction execute(input) {\n    print(\"Register pre-processor\");\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"// Register processor\nfunction execute(input) {\n    print(\"Register processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort(true);\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"// Register post processor\nfunction execute(input) {\n    print(\"Register post-processor\");\n\n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"form","id":"936599a5-f32b-43d8-9fc2-11788f10a11c","requestType":"POST","processing":{"preProcessor":{"type":"pre-processor","script":{"contents":"// Terms pre-processor\nfunction execute(input) {\n    print(\"Terms pre-processor\");\n    return true;\n}\n","language":"ECMASCRIPT"}},"processor":{"type":"processor","script":{"contents":"// Terns processor\nfunction execute(input) {\n    print(\"Terms processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var formData = scriptInput.formData;\n\n    var memberHandler = input[\"campaign.handler.db\"].member;\n\n    var memberExists = memberHandler.existsByMobileNumber(context.providerId, formData.mobileNumber, \"PATIENT\");\n\n    if (memberExists) {\n        retVal = nav.failureNav;\n        retVal.title = \"Looks like you have already registered\";\n        retVal.mustAbort(true);\n    } else {\n        retVal = nav.successNav;\n    }\n\n    return retVal;\n}\n","language":"ECMASCRIPT"}},"postProcessor":{"type":"post-processor","script":{"contents":"// Terms post processor\nfunction execute(input) {\n    print(\"Terms post processor\");\n\n    var scriptInput = input[\"campaign.script\"];\n\n    var nav = scriptInput.nav;\n    var context = scriptInput.context;\n    var authToken = context.authToken;\n\n    var mh = input[\"campaign.handler.db\"].member;\n    var wdh = input[\"campaign.handler.db\"].workflowData;\n    var uh = input[\"campaign.handler.http.rpm\"].user;\n    var ph = input[\"campaign.handler.pdf\"].pdf;\n\n    var userFormData = wdh.get(authToken.providerId, context.campaignId, context.containerId, 1);\n    var signatureFormData = wdh.get(authToken.providerId, context.campaignId, context.containerId, 2);\n\n    var consentDocUrl = ph.transform(\"ConsentForm.pdf\", context.campaignId, signatureFormData.file);\n\n    var memberInput = scriptInput.newMember();\n\n    memberInput.providerId = authToken.providerId;\n    memberInput.firstName = userFormData.firstName;\n    memberInput.lastName = userFormData.lastName;\n    memberInput.mobileNumber = userFormData.mobileNumber;\n    memberInput.roleName = \"PATIENT\";\n    memberInput.consentDocUrl = consentDocUrl;\n\n    var memberId = mh.add(memberInput);\n\n    var userInput = {\n        templateType: \"CHF\",\n        firstName: userFormData.firstName,\n        lastName: userFormData.lastName,\n        mobileNumber: userFormData.mobileNumber,\n        consentDocUrl: consentDocUrl,\n        phoneType: \"mobile\",\n        userType: \"PATIENT\",\n        role: \"patient\",\n        userName: userFormData.mobileNumber,\n        clinicId: authToken.providerId,\n        billingApproverId: authToken.approverId,\n        billingApproverName: authToken.approverName,\n        initialPassword: \"123456\"\n    };\n\n    var userOutput = uh.create(userInput);\n\n    print(\"User output: \" + userOutput);\n \n    return true;\n}\n","language":"ECMASCRIPT"}}},"successNav":{"type":"title","id":"488f3e3c-1f7e-462b-9723-171d4ab55ed7","requestType":"PUT","title":"Thank you. You should receive an SMS","buttonText":"Finish","hint":"Press ENTER"},"failureNav":{"type":"title","id":"185bb615-ba10-4439-81da-5e948fd7c98b","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"url","title":"Consent Form","url":"https://s3-us-west-2.amazonaws.com/com.kencorhealth.campaign/ConsentForm.pdf"},{"type":"file-input","fieldName":"signature","hint":"Signature"}],"title":"Terms","buttonText":"Submit","hint":"Press ENTER"},"failureNav":{"type":"title","id":"4868e2af-1e40-4a1d-8832-b238edbd3f78","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"items":[{"type":"text-input","fieldName":"firstName","title":"First Name","hint":"Enter first name"},{"type":"text-input","fieldName":"lastName","title":"Last Name","hint":"Enter last name"},{"type":"text-input","fieldName":"mobileNumber","title":"Mobile Number","hint":"Enter mobile number"}],"title":"Enter details","buttonText":"Submit","hint":"Press ENTER"}},"elseCondition":{"type":"else","nav":{"type":"title","id":"4560e99e-b218-4f58-94b9-27ed52c43e7f","requestType":"PUT","title":"Sorry, you need a smartphone","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"cdedae00-4a66-40ab-b0ee-20a6165d76de","requestType":"PUT","title":"Oops. No condition matched. Check your script","buttonText":"Finish","hint":"Press ENTER"}},"failureNav":{"type":"title","id":"42eb2a16-ce6a-4efb-a6da-10f45e03b15d","requestType":"PUT","title":"Oops, something went wrong","buttonText":"Finish","hint":"Press ENTER"},"choices":[{"type":"choice-input","fieldName":"yes","title":"Yes","fieldValue":"Yes"},{"type":"choice-input","fieldName":"no","title":"No","fieldValue":"No"}],"choiceType":"SINGLE","title":"Do you have a smartphone?","buttonText":"Next","hint":"Press ENTER"}]}}}' \
	http://srini.kencorhealth.com:6060/api/campaign

